name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  WWWGROUP: 1000

jobs:
  tests:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/8.4/Dockerfile
          push: false
          load: true
          tags: aidesk-mini:testing
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            WWWGROUP=${{ env.WWWGROUP }}

      - name: Create .env file from GitHub variables
        run: |
          cat > .env <<EOF
          ${{ vars.CI_ENV_VARS }}
          EOF

      - name: Run tests in Docker container
        run: |
          docker run --rm \
            --entrypoint="" \
            -v ${{ github.workspace }}:/var/www/html \
            -w /var/www/html \
            -e APP_ENV=testing \
            -e WWWGROUP=$(id -g) \
            -e WWWUSER=$(id -u) \
            -e COMPOSER_HOME=/tmp/.composer \
            -e DB_CONNECTION=sqlite \
            -e DB_DATABASE=/var/www/html/database/database.sqlite \
            aidesk-mini:testing \
            bash -c "
              set -e &&
              echo '=== DEBUG: Starting setup ===' &&
              echo 'Current user: $(whoami)' &&
              echo 'Current directory: $(pwd)' &&
              echo 'WWWUSER: $WWWUSER' &&
              echo 'WWWGROUP: $WWWGROUP' &&
              echo '' &&
              echo '=== DEBUG: Creating directories ===' &&
              mkdir -p database storage/framework/{cache,sessions,views} bootstrap/cache vendor &&
              echo 'Directories created' &&
              touch database/database.sqlite &&
              echo 'Database file created' &&
              echo '' &&
              echo '=== DEBUG: Setting permissions ===' &&
              chmod -R 777 storage bootstrap/cache database vendor 2>/dev/null || true &&
              ls -la | head -20 &&
              echo '' &&
              echo '=== DEBUG: Checking composer ===' &&
              which composer &&
              composer --version &&
              echo '' &&
              echo '=== DEBUG: Checking composer.json ===' &&
              [ -f composer.json ] && echo 'composer.json exists' || echo 'ERROR: composer.json not found' &&
              [ -f composer.lock ] && echo 'composer.lock exists' || echo 'WARNING: composer.lock not found' &&
              echo '' &&
              echo '=== DEBUG: Running composer install ===' &&
              rm -rf vendor/ 2>/dev/null || true &&
              mkdir -p vendor &&
              chmod 777 vendor &&
              composer install --no-ansi --no-interaction --no-scripts --prefer-dist -vvv 2>&1 || (echo 'ERROR: composer install failed with exit code:' $? && exit 1) &&
              echo '' &&
              echo '=== DEBUG: Checking vendor directory ===' &&
              echo 'Vendor directory exists:' && [ -d vendor ] && echo 'YES' || echo 'NO' &&
              echo 'Vendor directory contents:' && ls -la vendor/ 2>&1 | head -20 || echo 'ERROR: Cannot list vendor directory' &&
              echo 'Checking for autoload.php:' && [ -f vendor/autoload.php ] && echo 'SUCCESS: vendor/autoload.php exists' || (echo 'ERROR: vendor/autoload.php not found' && echo 'Full vendor listing:' && ls -laR vendor/ 2>&1 | head -50 && exit 1) &&
              echo '' &&
              echo '=== DEBUG: Running artisan commands ===' &&
              php artisan key:generate &&
              php artisan config:clear &&
              php artisan migrate --force &&
              php artisan test
            "

  code-quality:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/8.4/Dockerfile
          push: false
          load: true
          tags: aidesk-mini:testing
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            WWWGROUP=${{ env.WWWGROUP }}

      - name: Run Pint in Docker container
        run: |
          docker run --rm \
            --entrypoint="" \
            -v ${{ github.workspace }}:/var/www/html \
            -w /var/www/html \
            -e WWWGROUP=$(id -g) \
            -e WWWUSER=$(id -u) \
            -e COMPOSER_HOME=/tmp/.composer \
            aidesk-mini:testing \
            bash -c "
              composer install --no-ansi --no-interaction --no-scripts --no-progress --prefer-dist &&
              vendor/bin/pint --test
            "
